<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>BITSCTF Writeup - SixFoisNeuf</title><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="BITSCTF Writeup"><meta property="og:description" content="Here&rsquo;s a quick writeup on the two challenges I solved (Banana Princess and Beginner&rsquo;s luck) during BITSCTF with the Cryptis team. It was my first CTF and a great experience :D
Banana Princess For this challenge, we were given a PDF file which was said to have been encrypted.
Hexdump, search for a header By running hexdump -C MinionQuest.pdf | head, we can get the header of the PDF file."><meta property="og:type" content="article"><meta property="og:url" content="https://sixfoisneuf.fr/posts/bitsctf-writeup/"><meta property="article:published_time" content="2017-02-06T14:59:00+01:00"><meta property="article:modified_time" content="2017-02-06T14:59:00+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="BITSCTF Writeup"><meta name=twitter:description content="Here&rsquo;s a quick writeup on the two challenges I solved (Banana Princess and Beginner&rsquo;s luck) during BITSCTF with the Cryptis team. It was my first CTF and a great experience :D
Banana Princess For this challenge, we were given a PDF file which was said to have been encrypted.
Hexdump, search for a header By running hexdump -C MinionQuest.pdf | head, we can get the header of the PDF file."><link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://sixfoisneuf.fr/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://sixfoisneuf.fr/css/main.css><script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script><script src=https://sixfoisneuf.fr/js/main.js></script></head><body><div class="container wrapper post"><div class=header><base href=https://sixfoisneuf.fr/><h1 class=site-title><a href=https://sixfoisneuf.fr/>SixFoisNeuf</a></h1><div class=site-description><h2>Systems administration, DFIR and malware analysis</h2><nav class="nav social"><ul class=flat><a href=https://twitter.com/simsor title=Twitter><i data-feather=twitter></i></a><a href=https://github.com/simsor title=GitHub><i data-feather=github></i></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>Home</a></li><li><a href=/about>About me</a></li><li><a href=/posts/index.xml>RSS</a></li></ul></nav></div><div class=post-header><h1 class=title>BITSCTF Writeup</h1><div class=meta>Posted at &mdash; Feb 6, 2017</div></div><div class=markdown><p>Here&rsquo;s a quick writeup on the two challenges I solved (Banana Princess and Beginner&rsquo;s luck) during BITSCTF with the <a href=https://bitsctf.bits-quark.org/team/157>Cryptis</a> team. It was my first CTF and a great experience :D</p><h1 id=banana-princess>Banana Princess</h1><p>For this challenge, we were
given <a href=/documents/MinionQuest.pdf>a PDF file</a> which was said to have
been encrypted.</p><h2 id=hexdump-search-for-a-header>Hexdump, search for a header</h2><p>By running <code>hexdump -C MinionQuest.pdf | head</code>, we can get the header of the PDF file.</p><pre><code>00000000  25 43 51 53 2d 31 2e 35  0d 25 e2 e3 cf d3 0d 0a  |%CQS-1.5.%......|
00000010  34 20 30 20 62 6f 77 0d  3c 3c 2f 59 76 61 72 6e  |4 0 bow.&lt;&lt;/Yvarn|
00000020  65 76 6d 72 71 20 31 2f  59 20 34 33 30 31 39 30  |evmrq 1/Y 430190|
00000030  2f 42 20 36 2f 52 20 34  30 34 33 34 33 2f 41 20  |/B 6/R 404343/A |
00000040  31 2f 47 20 34 32 39 39  39 31 2f 55 20 5b 20 35  |1/G 429991/U [ 5|
00000050  37 36 20 31 35 35 5d 3e  3e 0d 72 61 71 62 6f 77  |76 155]&gt;&gt;.raqbow|
00000060  0d 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |.               |
00000070  20 20 0d 0a 6b 65 72 73  0d 0a 34 20 31 34 0d 0a  |  ..kers..4 14..|
00000080  30 30 30 30 30 30 30 30  31 36 20 30 30 30 30 30  |0000000016 00000|
00000090  20 61 0d 0a 30 30 30 30  30 30 30 37 33 31 20 30  | a..0000000731 0|
</code></pre><p>We can see the header is <code>CQS-1.5</code>. A normal PDF file header is
<code>PDF-1.5</code> (I used a reference PDF file to find this).</p><h2 id=find-the-encryption-method>Find the encryption method</h2><p>By inputting CQS into <a href=http://www.dcode.fr/chiffre-cesar>http://www.dcode.fr/chiffre-cesar</a>,
we can see that a rotation of 13 gives us <code>PDF</code>.</p><h2 id=unencrypt-it>Unencrypt it</h2><p>The file may have been encrypted by using a Caesar cipher on the
letters and leaving everything else alone. I wrote a Python script
to unencrypt it.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:green>#!/usr/bin/env python2</span>
   
<span style=color:#00f>import</span> codecs
    
res = <span style=color:#a31515></span><span style=color:#a31515>&#34;</span><span style=color:#a31515>&#34;</span>
<span style=color:#00f>with</span> open(<span style=color:#a31515></span><span style=color:#a31515>&#34;</span><span style=color:#a31515>MinionQuest.pdf2</span><span style=color:#a31515>&#34;</span>, <span style=color:#a31515></span><span style=color:#a31515>&#34;</span><span style=color:#a31515>r</span><span style=color:#a31515>&#34;</span>) <span style=color:#00f>as</span> f, open(<span style=color:#a31515></span><span style=color:#a31515>&#34;</span><span style=color:#a31515>result.pdf</span><span style=color:#a31515>&#34;</span>, <span style=color:#a31515></span><span style=color:#a31515>&#34;</span><span style=color:#a31515>w</span><span style=color:#a31515>&#34;</span>) <span style=color:#00f>as</span> out:
    <span style=color:#00f>for</span> b <span style=color:#00f>in</span> f.read():
        <span style=color:#00f>if</span> ord(b) <span style=color:#00f>in</span> range(ord(<span style=color:#a31515></span><span style=color:#a31515>&#34;</span><span style=color:#a31515>a</span><span style=color:#a31515>&#34;</span>), ord(<span style=color:#a31515></span><span style=color:#a31515>&#34;</span><span style=color:#a31515>z</span><span style=color:#a31515>&#34;</span>)+1) <span style=color:#00f>or</span> ord(b) <span style=color:#00f>in</span> range(ord(<span style=color:#a31515></span><span style=color:#a31515>&#34;</span><span style=color:#a31515>A</span><span style=color:#a31515>&#34;</span>), ord(<span style=color:#a31515></span><span style=color:#a31515>&#34;</span><span style=color:#a31515>Z</span><span style=color:#a31515>&#34;</span>)+1):
            <span style=color:green># Then b = letter</span>
            b = codecs.encode(b, <span style=color:#a31515></span><span style=color:#a31515>&#34;</span><span style=color:#a31515>rot_13</span><span style=color:#a31515>&#34;</span>)
        res += b
    
    out.write(res)
</code></pre></div><p>The resulting PDF file had a message with a black bar over the key.</p><h2 id=extracting-the-key>Extracting the key</h2><p>I extracted the images using <code>pdfimages</code> :</p><pre><code>pdfimages -png result.pdf images
</code></pre><p>The first image had the key written on it! <code>BITSCTF{save_the_kid}</code></p><h1 id=beginners-luck>Beginner&rsquo;s luck</h1><p>This challenge gave a <a href=/documents/BITSCTFfullhd.png>PNG file</a> and <a href=/documents/enc27.py>some encryption code</a>. The goal was to find a flaw in the encryption to decrypt the file and get the key!</p><h2 id=analysing-the-encryption-code>Analysing the encryption code</h2><p>The encryption code provided with the challenge was a pretty
straightforward XOR-cipher with a 24-byte long key.</p><p>The only working attack against this is a known-cleartext attack.</p><h2 id=reading-up-on-the-png-file-format--counting-bytes>Reading up on the PNG file format & counting bytes</h2><p>Fortunately for us, <a href=http://www.libpng.org/pub/png/spec/1.2/PNG-Structure.html>PNG files have a fixed header</a>, so it&rsquo;s pretty
easy to get the first 8 bytes of the key. <a href=http://stackoverflow.com/a/5354562>The IHDR header is also
always at the same place</a>…4 more bytes!</p><p>We can also guess the size of the picture, as the filename is
<code>fullhd.png</code>, we can assume the size is 1920x1080. That&rsquo;s 8 more
bytes!</p><p>Finally, I had to guess the size of the IHDR header…got it first
try (0x0D)! That&rsquo;s another 4 bytes :D</p><p><code>8 + 4 + 8 + 4 = 24</code></p><p>=> We&rsquo;ve got the full key.</p><h2 id=cracking-the-key-and-decrypting>Cracking the key and decrypting</h2><p>The program then uses that key to decrypt the file.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:green>#!/usr/bin/env python</span>
<span style=color:green># coding: utf-8</span>

<span style=color:#00f>from</span> enc27 <span style=color:#00f>import</span> supa_encryption

<span style=color:#00f>with</span> open(<span style=color:#a31515></span><span style=color:#a31515>&#34;</span><span style=color:#a31515>BITSCTFfullhd.png</span><span style=color:#a31515>&#34;</span>, <span style=color:#a31515></span><span style=color:#a31515>&#34;</span><span style=color:#a31515>rb</span><span style=color:#a31515>&#34;</span>) <span style=color:#00f>as</span> f:
    txt = f.read()

known_offsets = {
    <span style=color:green># Magic sequence</span>
    0: 0x89,
    1: 0x50,
    2: 0x4E,
    3: 0x47,
    4: 0x0D,
    5: 0x0A,
    6: 0x1A,
    7: 0x0A,
    
    <span style=color:green># IHDR length</span>
    8: 0x00,
    9: 0x00,
    10: 0x00,
    11: 0x0d,
    
    <span style=color:green># IHDR</span>
    12: 0x49,
    13: 0x48,
    14: 0x44,
    15: 0x52,
    
    <span style=color:green># Width: 1920</span>
    16: 0x00,
    17: 0x00,
    18: 0x07,
    19: 0x80,
    
    <span style=color:green># Height: 1080</span>
    20: 0x00,
    21: 0x00,
    22: 0x04,
    23: 0x38
}
key = [<span style=color:#a31515></span><span style=color:#a31515>&#34;</span><span style=color:#a31515>ø</span><span style=color:#a31515>&#34;</span>] * 24
i = 0

<span style=color:#00f>for</span> b <span style=color:#00f>in</span> txt:
    <span style=color:#00f>if</span> i <span style=color:#00f>in</span> known_offsets.keys():
        q = known_offsets[i]
        c = ord(b)
    
        d = c ^ q
        keyidx = i % 24
        key[keyidx] = chr(d)
    i += 1
    
<span style=color:#00f>print</span>(<span style=color:#a31515></span><span style=color:#a31515>&#34;</span><span style=color:#a31515>Key found: </span><span style=color:#a31515>%s</span><span style=color:#a31515>&#34;</span> % (<span style=color:#a31515></span><span style=color:#a31515>&#39;</span><span style=color:#a31515>&#39;</span>.join(key)))

<span style=color:#00f>with</span> open(<span style=color:#a31515></span><span style=color:#a31515>&#39;</span><span style=color:#a31515>BITSCTFfullhd.png</span><span style=color:#a31515>&#39;</span>,<span style=color:#a31515></span><span style=color:#a31515>&#39;</span><span style=color:#a31515>rb</span><span style=color:#a31515>&#39;</span>) <span style=color:#00f>as</span> f:
    data = f.read()
    
enc_data = <span style=color:#a31515></span><span style=color:#a31515>&#39;</span><span style=color:#a31515>&#39;</span>
<span style=color:#00f>for</span> i <span style=color:#00f>in</span> range(0, len(data), 24):
    enc = supa_encryption(data[i:i+24], key)
    enc_data += enc
    
<span style=color:#00f>with</span> open(<span style=color:#a31515></span><span style=color:#a31515>&#39;</span><span style=color:#a31515>fullhd.png</span><span style=color:#a31515>&#39;</span>, <span style=color:#a31515></span><span style=color:#a31515>&#39;</span><span style=color:#a31515>wb</span><span style=color:#a31515>&#39;</span>) <span style=color:#00f>as</span> f:
    f.write(enc_data)
</code></pre></div><p>The image file has the flag handwritten in it: <code>BITSCTF{p_en_gee}</code></p><p>The encryption key was <code>rkh%QP4g0&3g46@4*%f(UN#\</code></p></div><div class=post-tags></div></div><div class="footer wrapper"><nav class=nav><div><a href=https://github.com/vividvilla/ezhil>Ezhil theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></nav></div><script>feather.replace()</script></body></html>